[Back to start page](README.md)

# Installation

## Prerequisites

* Linux-based OS (GenomeDepot was developed and tested in 64-bit Ubuntu Linux system)
* Python 3.8+ 
* conda (anaconda is recommended)
* MySQL server
* Apache2 web-server with mod_wsgi and ssl extensions
* Muscle
* HMMER
* NCBI-BLAST (blastp and megablast required)
* Perl
* zlib1g-dev package
* curl
* git

In Ubuntu-based distibutions, you can install these dependencies using the APT package manager:
```
sudo apt install apache2 mysql-server muscle hmmer ncbi-blast+-legacy build-essential zlib1g-dev libexpat1-dev python3-dev libmysqlclient-dev curl git
```

## Install dependencies

Create a directory where GenomeDepot and external tools will be installed. This document uses the /opt/genomedepot directory as an example, but installation in this directory requires sudo rights. Installing GenomeDepot in the user’s home directory is not recommended because of possible issues with file access and web app execution by the web server.

```
cd /opt
sudo mkdir genomedepot
```
If you created the genomedepot directory with sudo, change the directory ownership to a non-root user (replace USERNAME with a real user name):
```
sudo chown USERNAME:www-data genomedepot
```
Create apps subdirectory. In this directory, GenomeDepot-based portals will be installed. 
```
cd genomedepot
mkdir apps
cd apps
```
Create a directory for a new GenomeDepot portal in genomedepot/apps (for example, mygenomes) and clone the repository into it.
```
mkdir mygenomes
cd mygenomes
git clone https://github.com/aekazakov/genome-depot
```
Run installation script that will install external tools and create virtual environment. Running it may take quite some time for the first GenomeDepot-based portal because it will make all the conda environments and download reference data.
```
cd genome-depot
bash install.sh
```
The install.sh script creates Python virtual environment and installs the required Python libraries including Django framework, genome annotation tools and other dependencies. If it fails, check the error message, fix the problem and start install.sh again.
The most common problem is a name conflict with existing conda environments. In this case, the installation script does not overwrite the existing environment but stops the installation. User can rename or delete the existing environment before restarting the installation.

Another common problem is an incomplete installation of the operon prediction tool POEM. If POEM fails to predict operons, and running poem.sh script throws an error "AttributeError: module 'tensorflow' has no attribute 'get_default_graph'", it means the versions of keras and tensorflow are not compatible. Activate conda genomedepot-poem environment and run `pip install tensorflow==1.13.1`.

## Initial GenomeDepot configuration

Create MySQL user (for example, gduser), if needed, or use an existing mysql account.
Create MySQL database (for example, gdgenomes):
log into mysql as root: 
```
mysql -u root -p
```

Enter commands that create the database and grant the user access to the database:
```
CREATE DATABASE gdgenomes CHARACTER SET utf8;
GRANT ALL PRIVILEGES ON gdgenomes.* TO 'gduser'@'localhost';
quit
```
Copy the genomedepot/apps/mygenomes/genome-depot/genomebrowser/.env.template file to genomedepot/apps/mygenomes/genome-depot/genomebrowser/.env. Open genomedepot/apps/mygenomes/genome-depot/genomebrowser/.env in a text editor and enter the settings:

* SECRET_KEY: Django secret key
* ALLOWED_HOSTS: comma-separated list of host names and IP addresses for the web server (like example.com,127.0.0.1,testserver)
* INTERNAL_IPS: comma-separated list of IP addresses for this site (usually, 127.0.0.1,)
* DB_USER: mysql user name (created at step 1)
* DB_PASSWORD: mysql password (created at step 1)
* DB_NAME: mysql database name (created at step 2)
* STATIC_URL: URL for static files directory (for example, https://example.com/gdstatic/mygenomes/)
* TITLE: web site title 
* BASE_URL: URL of the web site. It can be a domain name (https://example.com/) or a subdirectory (https://example.com/mygenomes/)
* ADMIN: admin name and email separated by comma (John Doe,johndoe@example.com)
* EMAIL_HOST_USER: an email address for GenomeDepot to send messages from (mygenomes@example.com)
* EMAIL_HOST_PASSWORD: a password for the EMAIL_HOST_USER email 
* EMAIL_HOST: external e-mail server address
* STATIC_ROOT: the full path of a directory for static files from which the web server serves up STATIC_URL. For example, /opt/genomedepot/static/mygenomes
* STATICFILES_DIR: a directory with static files in the GenomeDepot installation. For example, /opt/genomedepot/apps/mygenomes/genome-depot/genomebrowser/static.

Open /opt/genomedepot/apps/mygenomes/genome-depot/genomebrowser/configs.txt in a text editor. This file is generated by the GenomeDepot installation script and contains GenomeDepot configuration parameters to be saved in the database. Check the parameters for correctness.

Activate virtual environment genomedepot-venv, change directory to /opt/genomedepot/app/mygenomes/genome-depot/genomebrowser and run Django configuration commands
```
source /opt/genomedepot/genomedepot-venv/bin/activate
cd /opt/genomedepot/app/mygenomes/genome-depot/genomebrowser
python manage.py collectstatic
python manage.py makemigrations
python manage.py migrate
python manage.py createsuperuser (Enter your desired username, email and password).
python manage.py import_config -i configs.txt
python manage.py createcachetable
```

Now your new GenomeDepot portal is ready for testing. Run 
```
python manage.py runserver 127.0.0.1:8000
```
and open in the browser <http://127.0.0.1:8000/admin>. You should be able to log in with the superuser username and password you just created.
 
If test server cannot find static files, check if www-data user can read from the /opt/genomedepot/static/mygenomes directory (giving rw permissions for www-data group would work).

##How to configure Apache web server for GenomeDepot

You need sudo privileges for changing Apache configuration files. Open apache2 site configuration file (it may be /etc/apache2/sites_availalbel/default_ssl.conf) in a text editor and add the following (with correct paths):
```
WSGIDaemonProcess genomedepotpy python-home=/opt/genomedepot/genomedepot-venv python-path=/opt/genomedepot/app/mygenomes/genome-depot/genomebrowser
WSGIScriptAlias /mygenomes /opt/genomedepot/app/mygenomes/genome-depot/genomebrowser/genomebrowser/wsgi.py process-group=genomedepotpy application-group=%{GLOBAL}
<Directory /opt/genomedepot/app/mygenomes/genome-depot/genomebrowser/genomebrowser/>
<Files wsgi.py>

    Require all granted

</Files>
<Directory /opt/genomedepot/static/>
Options -Indexes +FollowSymLinks

<IfModule mod_headers.c>

  Header set Access-Control-Allow-Origin http://127.0.0.1:8000

</IfModule>

Require all granted
Alias /gdstatic /opt/genomedepot/static/
```
You may have to add "Header always set X-Frame-Options "SAMEORIGIN"" to web server configuration if the embedded genome viewer is not properly displayed.
Restart apache2:
```
sudo systemctl restart apache2
```
Now you would be able to open https://your.domain.name/mygenomes in a web browser.

##Start Django Q cluster manually

A Django Q cluster must be started for running GenomeDepot pipeline jobs from the task queue. To start the cluster, start a new screen session with “screen” command and enter:
```
conda deactivate
source /<GenomeDepot venv path>/bin/activate
cd /<GenomeDepot path>/genomebrowser
python manage.py qcluster
```
Optionally, the screen session can be named. Press Ctrl-A, then type “:sessionname “ and type a name.

After that, detach the screen session (press Ctrl-A, then d).

If the cluster is up and running, the number of clusters in the administration panel changes from 0 to 1.
There is no need to run more than one cluster for a GenomeDepot-based portal, since only one task can be processed at any moment. The GenomeDepot pipeline does not let parallel processing of tasks to prevent concurrent modification of the data.

To stop the Django Q cluster, attach the screen session with “screen -r” command, and press Ctrl-C.

## Start Django Q cluster from crontab

The Django Q cluster can be started on server restart as a cron job. First, create a bash script that starts the cluster:
```
#!/usr/bin/bash
conda deactivate
source /<GenomeDepot venv path>/bin/activate
cd /<GenomeDepot path>/genomebrowser
python manage.py qcluster
```
Then, open cron file (crontab -e) and add a line to the end:
```
@reboot(. ~/.profile /usr/bin/screen -dmS gdcluster <path to the shell script>)
```
Save the file and exit the editor.
To stop a cluster, run “screen -r gdcluster” command and press Ctrl-C. Warning: if the cluster is running a task, it may not stop immediately, and some data may be lost or corrupted.
If you have more than one GenomeDepot-based portal, change “gdcluster” to a unique name for each screen session. 

## How to change site background image

There are two background images in the repository, one for the dark mode (genomebrowser/static/images/background.jpg) and the other for the light mode (genomebrowser/static/images/background_light.jpg). You can replace them, then run `python manage.py collectstatic` command and restart Apache web server.

## Tweak MySQL configuration 

As the genome database grows, MySQL performance may decrease because of excessive I/O usage. To increase MySQL performance, change innodb_buffer_pool_size parameter in MySQL configuration file. Run the following query in the mysql window to find optimal innodb_buffer_pool_size:

SELECT CEILING(Total_InnoDB_Bytes*1.6/POWER(1024,3)) RIBPS FROM (SELECT SUM(data_length+index_length) Total_InnoDB_Bytes FROM information_schema.tables WHERE engine='InnoDB') A;

It will show RIBPS value in gigabytes. If your server has enough memory, enter that number into the mysqld section of mysqld.conf (/etc/mysql/mysql.conf.d/mysqld.conf) and add “G”, for example:

[mysqld]
innodb_buffer_pool_size=8G

After that, restart MySQL.

## Third-party tools installed with GenomeDepot

* **eggNOG-mapper** [Molecular Biology and Evolution, 2021, msab293](https://doi.org/10.1093/molbev/msab293)

* **POEM_py3K** [bioRxiv, 2019.12.20.885269](https://doi.org/10.1101/2019.12.20.885269)

* **Jbrowse** [Genome Biology ,2016, 17: 66](https://doi.org/10.1186/s13059-016-0924-1)

* **samtools** [GigaScience, 2021, giab008](https://doi.org/10.1093/gigascience/giab008)

* **AMRFinderPlus** [Sci Rep, 2021, 11: 12728](https://doi.org/10.1038/s41598-021-91456-0)

* **antiSMASH** [Nucleic Acids Research, 2021, 49: W29](https://doi.org/10.1093/nar/gkab335)

* **eCIS-screen** [Cell Rep, 2019, 29: 511](https://doi.org/10.1016/j.celrep.2019.08.096)

* **Fama** [https://github.com/aekazakov/fama](https://github.com/aekazakov/fama)

* **PhiSpy** [Nucleic Acids Research, 2012, 40: e126](https://doi.org/10.1093/nar/gks406)

* **GapMind** [mSystems, 2020, 5: e00291-20](https://doi.org/10.1128/mSystems.00291-20)

* **DefenseFinder** [Nature Communications, 2022, 13: 2561](https://doi.org/10.1038/s41467-022-30269-9)

* **MacsyFinder** [PLoS One, 2014, 9: e110726](https://doi.org/10.1371/journal.pone.0110726)

* **geNomad** [Nature Biotechnology, 2023](https://doi.org/10.1038/s41587-023-01953-y)

* **HMMER** [PLoS Comput Biol, 2011, 7: e1002195](https://doi.org/10.1371/journal.pcbi.1002195)


[Back to start page](README.md)

# Installation

## Prerequisites

Linux-based OS with installed and . CGCMS was developed and tested in 64-bit Ubuntu Linux system.

* Python 3.8+ 
* conda (anaconda is recommended)
* MySQL server
* Apache2 web-server with mod_wsgi and ssl extensions
* Muscle
* HMMER
* NCBI-BLAST (blastp and megablast required)
* Perl
* zlib1g-dev package
* curl
* git

In Ubuntu-based distibutions, you can install these dependencies using the APT package manager:
```
sudo apt install apache2 mysql-server muscle hmmer ncbi-blast+-legacy build-essential zlib1g-dev libexpat1-dev python3-dev libmysqlclient-dev curl git
```

## Install dependencies

Create a directory where CGCMS and external tools will be installed. This document uses the /opt/cgcms directory as an example, but installation in this directory requires sudo rights. Installing CGCMS in the user’s home directory is not recommended because of possible issues with file access and web app execution by the web server.

```
cd /opt
sudo mkdir cgcms
```
If you created the cgcms directory with sudo, change the directory ownership to a non-root user (replace USERNAME with a real user name):
```
sudo chown USERNAME:www-data cgcms
```
Create apps subdirectory. In this directory, CGCMS-based portals will be installed. 
```
cd cgcms
mkdir apps
cd apps
```
Create a directory for a new CGCMS portal in cgcms/apps (for example, mygenomes) and clone the repository into it.
```
mkdir mygenomes
cd mygenomes
git clone https://github.com/aekazakov/CGCMS
```
Run installation script that will install external tools and create virtual environment. Running it may take quite some time for the first CGCMS-based portal because it will make all the conda environments and download reference data.
cd CGSMS
```
bash install.sh
```
The install.sh script creates Python virtual environment and installs the required Python libraries including Django framework, genome annotation tools and other dependencies. If it fails, check the error message, fix the problem and start install.sh again.
The most common problem is a name conflict with existing conda environments. In this case, the installation script does not overwrite the existing environment but stops the installation. User can rename or delete the existing environment before restarting the installation.

Another common problem is an incomplete installation of the operon prediction tool POEM. If POEM fails to predict operons, and running poem.sh script throws an error "AttributeError: module 'tensorflow' has no attribute 'get_default_graph'", it means the versions of keras and tensorflow are not compatible. Activate conda cgcms-poem environment and run `pip install tensorflow==1.13.1`.

## Initial CGCMS configuration

Create MySQL user (for example, cgcmsuser), if needed, or use an existing mysql account.
Create MySQL database (for example, cgcmsmygenomes):
log into mysql as root: 
```
mysql -u root -p
```

Enter commands that create the database and grant the user access to the database:
```
CREATE DATABASE cgcmsmygenomes CHARACTER SET utf8;
GRANT ALL PRIVILEGES ON cgcmsmygenomes.* TO 'cgcmsuser'@'localhost';
quit
```
Copy the cgcms/apps/mygenomes/CGCMS/genomebrowser/.env.template file to cgcms/apps/mygenomes/CGCMS/genomebrowser/.env. Open cgcms/apps/mygenomes/CGCMS/genomebrowser/.env in a text editor and enter the settings:

* SECRET_KEY: Django secret key
* ALLOWED_HOSTS: comma-separated list of host names and IP addresses for the web server (like example.com,127.0.0.1,testserver)
* INTERNAL_IPS: comma-separated list of IP addresses for this site (usually, 127.0.0.1,)
* DB_USER: mysql user name (created at step 1)
* DB_PASSWORD: mysql password (created at step 1)
* DB_NAME: mysql database name (created at step 2)
* STATIC_URL: URL for static files directory (for example, https://example.com/cgcmsstatic/mygenomes/)
* TITLE: web site title 
* BASE_URL: URL of the web site. It can be a domain name (https://example.com/) or a subdirectory (https://example.com/mygenomes/)
* ADMIN: admin name and email separated by comma (John Doe,johndoe@example.com)
* EMAIL_HOST_USER: an email address for CGCMS to send messages from (mygenomes@example.com)
* EMAIL_HOST_PASSWORD: a password for the EMAIL_HOST_USER email 
* EMAIL_HOST: external e-mail server address
* STATIC_ROOT: the full path of a directory for static files from which the web server serves up STATIC_URL. For example, /opt/cgcms/static/mygenomes
* STATICFILES_DIR: a directory with static files in the CGCMS installation. For example, /opt/cgcms/apps/mygenomes/CGCMS/genomebrowser/static.

Open /opt/cgcms/apps/mygenomes/CGCMS/genomebrowser/configs.txt in a text editor. This file is generated by the CGCMS installation script and contains CGCMS configuration parameters to be saved in the database. Check the parameters for correctness.

Activate virtual environment cgcms-venv, change directory to /opt/cgcms/app/mygenomes/CGCMS/genomebrowser and run Django configuration commands
```
source cgcms/cgcms-venv/bin/activate
cd /opt/cgcms/app/mygenomes/CGCMS/genomebrowser
python manage.py collectstatic
python manage.py makemigrations
python manage.py migrate
python manage.py createsuperuser (Enter your desired username, email and password).
python manage.py import_config -i configs.txt
python manage.py createcachetable
```

Now your new CGCMS portal is ready for testing. Run 
```
python manage.py runserver 127.0.0.1:8000
```
and open in the browser <http://127.0.0.1:8000/admin>. You should be able to log in with the superuser username and password you just created.
 
If test server cannot find static files, check if www-data user can read from the cgcms/static/mygenomes directory (giving rw permissions for www-data group would work).

##How to configure Apache web server for CGCMS

You need sudo privileges for changing Apache configuration files. Open apache2 site configuration file (it may be /etc/apache2/sites_availalbel/default_ssl.conf) in a text editor and add the following (with correct paths):
```
WSGIDaemonProcess cgcmspy python-home=/opt/cgcms/cgcms-venv python-path=/opt/cgcms/app/mygenomes/CGCMS/genomebrowser
WSGIScriptAlias /mygenomes /opt/cgcms/app/mygenomes/CGCMS/genomebrowser/genomebrowser/wsgi.py process-group=cgcmspy application-group=%{GLOBAL}
<Directory /opt/cgcms/app/mygenomes/CGCMS/genomebrowser/genomebrowser/>
<Files wsgi.py>

    Require all granted

</Files>
<Directory /opt/cgcms/static/>
Options -Indexes +FollowSymLinks

<IfModule mod_headers.c>

  Header set Access-Control-Allow-Origin http://127.0.0.1:8000

</IfModule>

Require all granted
Alias /cgcmsstatic /opt/cgcms/static/
```
You may have to add "Header always set X-Frame-Options "SAMEORIGIN"" to web server configuration if the embedded genome viewer is not properly displayed.
Restart apache2:
```
sudo systemctl restart apache2
```
Now you would be able to open https://your.domain.name/mygenomes in a web browser.

##Start Django Q cluster manually

A Django Q cluster must be started for running CGCMS pipeline jobs from the task queue. To start the cluster, start a new screen session with “screen” command and enter:
```
conda deactivate
source /<CGCMS venv path>/bin/activate
cd /<CGCMS path>/genomebrowser
python manage.py qcluster
```
Optionally, the screen session can be named. Press Ctrl-A, then type “:sessionname “ and type a name.

After that, detach the screen session (press Ctrl-A, then d).

If the cluster is up and running, the number of clusters in the administration panel changes from 0 to 1.
There is no need to run more than one cluster for a CGCMS-based portal, since only one task can be processed at any moment. The CGCMS pipeline does not let parallel processing of tasks to prevent concurrent modification of the data.

To stop the Django Q cluster, attach the screen session with “screen -r” command, and press Ctrl-C.

## Start Django Q cluster from crontab

The Django Q cluster can be started on server restart as a cron job. First, create a bash script that starts the cluster:
```
#!/usr/bin/bash
conda deactivate
source /<CGCMS venv path>/bin/activate
cd /<CGCMS path>/genomebrowser
python manage.py qcluster
```
Then, open cron file (crontab -e) and add a line to the end:
```
@reboot(. ~/.profile /usr/bin/screen -dmS cgcmscluster <path to the shell script>)
```
Save the file and exit the editor.
To stop a cluster, run “screen -r cgcmscluster” command and press Ctrl-C. Warning: if the cluster is running a task, it may not stop immediately, and some data may be lost or corrupted.
If you have more than one CGCMS-based portal, change “cgcmscluster” to a unique name for each screen session. 

## How to change site background image

There are two background images in the repository, one for the dark mode (genomebrowser/static/images/background.jpg) and the other for the light mode (genomebrowser/static/images/background_light.jpg). You can replace them, then run `python manage.py collectstatic` command and restart Apache web server.

[Back to start page](README.md)